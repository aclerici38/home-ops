---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

vars:
  TALHELPER_CLUSTER_DIR: '{{.KUBERNETES_DIR}}/bootstrap/talos/clusterconfig'
  TALHELPER_SECRET_FILE: '{{.KUBERNETES_DIR}}/bootstrap/talos/talsecret.sops.yaml'
  TALHELPER_CONFIG_FILE: '{{.KUBERNETES_DIR}}/bootstrap/talos/talconfig.yaml'
  CLUSTER_DIR: '{{.ROOT_DIR}}/kubernetes'
  KUBE_BOOTSTRAP_DIR: '/Users/anthony/home-ops/kubernetes/bootstrap'

env:
  TALOSCONFIG: '{{.TALHELPER_CLUSTER_DIR}}/talosconfig'

tasks:
  save-kubeconfigs:
    desc: Save admin kubeconfigs for all clusters into 1Password
    cmds:
      - for:
          matrix:
            CLUSTER: [apartment, house, cloud]
        cmd: |
          echo "Saving kubeconfig for cluster: {{.ITEM.CLUSTER}}"
          kubeconfig=$(kubectl config view --minify --context admin@{{.ITEM.CLUSTER}} --raw)
          op item create --category=login --vault="Kubernetes" --title="{{.ITEM.CLUSTER}}-kubeconfig" kubeconfig[password]="$kubeconfig"

  apps:
    desc: Bootstrap Apps
    prompt: Bootstrap apps into the Talos cluster?
    cmds:
      - op run --env-file {{.KUBE_BOOTSTRAP_DIR}}/.secrets.env --no-masking -- bash -c 'export ONEPASSWORD_CREDENTIALS_B64=$(echo "$ONEPASSWORD_CREDENTIALS" | base64) && minijinja-cli --env {{.KUBE_BOOTSTRAP_DIR}}/apps/templates/resources.yaml.j2' | kubectl apply --server-side --filename -
      - helmfile --file {{.KUBE_BOOTSTRAP_DIR}}/apps/helmfile.yaml apply --skip-diff-on-install --suppress-diff
    env:
      FLUX_GITHUB_PUBLIC_KEYS:
        sh: curl -fsSL https://api.github.com/meta | jq --raw-output '"github.com "+.ssh_keys[]'
      NODE_COUNT:
        sh: talosctl config info --output json | jq --raw-output '.nodes | length'
      VAULT: Kubernetes
    preconditions:
      - op user get --me
      - talosctl config info
      - test -f {{.KUBE_BOOTSTRAP_DIR}}/.secrets.env
      - test -f {{.KUBE_BOOTSTRAP_DIR}}/apps/helmfile.yaml
      - test -f {{.KUBE_BOOTSTRAP_DIR}}/apps/templates/resources.yaml.j2
      - which curl jq helmfile kubectl op talosctl minijinja-cli
