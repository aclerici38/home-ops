---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app nfs-ganesha
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      main:
        pod:
          nodeSelector:
            kubernetes.io/hostname: bonds
        initContainers:
          mtab:
            image:
              repository: docker.io/library/busybox
              tag: latest
            command: [ "sh", "-c", "ln -sf /proc/self/mounts /mtab/mtab && ls -l /mtab" ]
        containers:
          *app :
            image:
              repository: docker.io/hectorm/nfs-ganesha
              tag: v9@sha256:930d4eed3df4cd246bacf5d920cfe4d5bfc831c13617c53bdaa16d1e197782c8
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "500m"
                memory: "512Mi"
            securityContext:
              readOnlyRootFilesystem: false
              allowPrivilegeEscalation: true
              seccompProfile: { type: RuntimeDefault }
              capabilities:
                drop:
                 - ALL
                add:
                  - CHOWN
                  - DAC_OVERRIDE
                  - DAC_READ_SEARCH
                  - FOWNER
                  - FSETID
                  - SETGID
                  - SETUID
                  - SYS_RESOURCE
    service:
      *app :
        controller: main
        annotations:
          io.cilium/lb-ipam-ips: 10.38.55.50
        ports:
          nfs:
            port: 2049
            protocol: TCP
    persistence:
      config:
        type: configMap
        name: ganesha-config
        globalMounts:
          - path: /etc/ganesha/ganesha.conf
            subPath: ganesha.conf
      minio:
        existingClaim: minio
        globalMounts:
          - path: /export/minio
      immich:
        existingClaim: immich
        globalMounts:
          - path: /export/immich
      media:
        existingClaim: media
        globalMounts:
          - path: /export/media
      recovery:
        type: emptyDir
      run:
        type: emptyDir
      tmp:
        type: emptyDir
      mtab:
        type: emptyDir
        advancedMounts:
          main:
            mtab:
              - path: /mtab
            *app :
              - path: /etc/mtab
                subPath: mtab
