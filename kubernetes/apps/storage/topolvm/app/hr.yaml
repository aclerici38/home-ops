---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: topolvm
spec:
  interval: 1h
  maxHistory: 1
  chart:
    spec:
      chart: topolvm
      version: 15.6.0
      sourceRef:
        kind: HelmRepository
        name: topolvm-charts
        namespace: flux-system
      interval: 1h
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    image:
      repository: ghcr.io/topolvm/topolvm-with-sidecar
      tag: 0.37.0@sha256:1c18d5e7a0b2f4ca970f5b73b9781f8bdb7b2236f717926e7c9f8eb61c6ab56a
      pullPolicy: IfNotPresent
    lvmd:
      managed: true
      nodeSelector: &ns
        kubernetes.io/hostname: bonds
      env:
        - name: LVM_SYSTEM_DIR
          value: /tmp
      deviceClasses:
        - name: vg0
          volume-group: topolvm
          default: true
          type: thin
          spare-gb: 10
          thin-pool:
            name: thinpool
            overprovision-ratio: 5.0
          devices:
            - /dev/disk/by-partlabel/r-topolvm
      prometheus:
        podMonitor:
          enabled: true
    node:
      lvmdEmbedded: false
      nodeSelector: *ns
      prometheus:
        podMonitor:
          enabled: true
    controller:
      prometheus:
        podMonitor:
          enabled: true
      tolerations:
        - key: "location"
          operator: "Equal"
          value: "cloud"
          effect: "NoSchedule"
        - key: "location"
          operator: "Equal"
          value: "house"
          effect: "NoSchedule"
    snapshot:
      enabled: true
    cert-manager:
      enabled: false
    storageClasses:
      - name: topolvm
        storageClass:
          fsType: xfs
          isDefaultClass: true
          volumeBindingMode: Immediate
          allowVolumeExpansion: true
          additionalParameters:
            "topolvm.io/device-class": "vg0"
