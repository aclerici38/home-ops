---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: patch
spec:
  patches:
    # https://blog.ferretdb.io/run-ferretdb-postgres-documentdb-extension-cnpg-kubernetes/
    # extensions initialized in the database CR
    # TODO: use imagevolume extensions once documentdb supports pg18
    - patch: |-
        apiVersion: postgresql.cnpg.io/v1
        kind: Cluster
        metadata:
          name: patch
        spec:
          managed:
            roles:
              - name: app
                login: true
                inRoles:
                  - documentdb_admin_role
          postgresUID: 999
          postgresGID: 999
          postgresql:
            pg_hba:
              # docuentdb extension tries to connect to db via localhost
              - host app app 127.0.0.1/32 trust
            shared_preload_libraries:
              - pg_cron
              - pg_documentdb_core
              - pg_documentdb
            parameters:
              cron.database_name: 'app'
              documentdb.bg_worker_database_name: 'app'
      target:
        kind: Cluster
