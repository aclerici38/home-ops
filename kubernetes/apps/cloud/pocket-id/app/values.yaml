---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/aee0d999ba805fc55c3989dd454b0b5116333079/charts/library/common/values.schema.json
controllers:
  main:
    strategy: RollingUpdate
    containers:
      *app :
        image:
          repository: ghcr.io/pocket-id/pocket-id
          tag: v0.43.1@sha256:293f0e22114f67793c5dccb853cf3d38050794e847370735701ec108938c2902
        command: ["/bin/sh", "/app/scripts/docker/entrypoint.sh"]
        env:
          PUBLIC_APP_URL: https://id.${SECRET_DOMAIN}
          TRUST_PROXY: "true"
          DB_PROVIDER: postgres
          CADDY_DISABLED: "true"
          UPDATE_CHECK_DISABLED: "true"

          EMAIL_LOGIN_NOTIFICATION_ENABLED: true

          POSTGRES_CONNECTION_STRING:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: uri
        envFrom:
          - secretRef:
              name: ${APP}-secret
        securityContext:
          readOnlyRootFilesystem: true
        resources:
          requests:
            cpu: 800m
            memory: 100Mi
          limits:
            memory: 4Gi
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile: { type: RuntimeDefault }
service:
  *app :
    controller: main
    ports:
      frontend:
        port: 3000
      backend:
        port: 8080
route:
  *app :
    hostnames:
      - id.${SECRET_DOMAIN}
    parentRefs:
      - name: external
        namespace: kube-system
        sectionName: https
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: /api
        backendRefs:
          - name: *app
            port: 8080
      - matches:
          - path:
              type: PathPrefix
              value: /.well-known
        backendRefs:
          - name: *app
            port: 8080
      - matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - name: *app
            port: 3000

persistence:
  data:
    existingClaim: *app
    globalMounts:
      - path: /data
      - path: /app/backend/data
        subPath: backend
