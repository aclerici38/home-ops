---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/aee0d999ba805fc55c3989dd454b0b5116333079/charts/library/common/values.schema.json
controllers:
  main:
    containers:
      *app :
        image:
          repository: ghcr.io/atuinsh/atuin
          tag: v18.4.0@sha256:8c6fa0aea944bf2a39665c9c69df1c2c0f9c05207bda5b942d450142285e3ee1
        args: ["server", "start"]
        env:
          ATUIN_HOST: 0.0.0.0
          ATUIN_PORT: &port 8888
          ATUIN_OPEN_REGISTRATION: true
          ATUIN_TLS__ENABLE: false
          ATUIN_TLS__CERT_PATH: ""
          ATUIN_TLS__PKEY_PATH: ""
          RUST_LOG: info
          ATUIN_DB_URI:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: uri
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
            spec:
              failureThreshold: 30
              periodSeconds: 5
        resources:
          requests:
            cpu: 10m
            memory: 128Mi
          limits:
            memory: 1Gi
        securityContext:
          readOnlyRootFilesystem: true
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile: { type: RuntimeDefault }
service:
  *app :
    controller: main
    ports:
      http:
        port: *port
route:
  *app :
    hostnames:
      - ${APP}.${SECRET_DOMAIN}
    parentRefs:
      - name: internal
        namespace: kube-system
        sectionName: https
    rules:
      - backendRefs:
          - name: *app
            port: *port
persistence:
  config:
    type: emptyDir
