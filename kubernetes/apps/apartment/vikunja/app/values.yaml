---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/aee0d999ba805fc55c3989dd454b0b5116333079/charts/library/common/values.schema.json
controllers:
  main:
    containers:
      ${APP}:
        image:
          repository: docker.io/vikunja/vikunja
          tag: 0.24.6@sha256:ed1f3ed467fecec0b57e9de7bc6607f8bbcbb23ffced6a81f5dfefc794cdbe3b
        env:
          VIKUNJA_SERVICE_PUBLICURL: &fqdn vikunja.${SECRET_DOMAIN}
          VIKUNJA_SERVICE_TIMEZONE: America/Los_Angeles
          POSTGRES_ENABLED: "true"
          VIKUNJA_MAILER_ENABLED: true
          VIKUNJA_METRICS_ENABLED: true
          VIKUNJA_DEFAULTSETTINGS_DISCOVERABLE_BY_NAME: true
          VIKUNJA_DEFAULTSETTINGS_EMAIL_REMINDERS_ENABLED: true
          discoverable_by_email: true
          overdue_tasks_reminders_time: '11:00'
          VIKUNJA_DEFAULTSETTINGS_WEEK_START: 1

          # postgres
          VIKUNJA_DATABASE_TYPE: postgres
          VIKUNJA_DATABASE_HOST:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: host
          VIKUNJA_DATABASE_USER:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: user
          VIKUNJA_DATABASE_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: password
          VIKUNJA_DATABASE_DATABASE:
            valueFrom:
              secretKeyRef:
                name: ${APP}-db-app
                key: dbname
        envFrom:
          - secretRef:
              name: vikunja-secret
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: &port 3456
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness: *probes
        securityContext:
          readOnlyRootFilesystem: true
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            memory: 8Gi
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile: { type: RuntimeDefault }
service:
  ${APP}:
    controller: main
    ports:
      http:
        port: *port
route:
  ${APP}:
    hostnames:
      - ${APP}.${SECRET_DOMAIN}
    parentRefs:
      - name: internal
        namespace: kube-system
        sectionName: https
    rules:
      - backendRefs:
          - name: ${APP}
            port: *port
persistence:
  files:
    existingClaim: ${APP}
    globalMounts:
      - path: /app/vikunja/files

  config-file:
    globalMounts:
      - path: /etc/vikunja/config.yml
        subPath: config.yml
    name: vikunja-config
    type: configMap
