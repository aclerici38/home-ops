---
# yaml-language-server: $schema=https://datreeio.github.io/CRDs-catalog/monitoring.coreos.com/alertmanagerconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
spec:
  route:
    groupBy: ["alertname", "job"]
    groupInterval: 10m
    groupWait: 1m
    receiver: discord
    repeatInterval: 12h
    routes:
      - receiver: "null"
        matchers:
          - name: alertname
            value: InfoInhibitor
            matchType: =
      - receiver: discord
        matchers:
          - name: severity
            value: critical
            matchType: =
          - name: alertname
            value: Watchdog
            matchType: =
  inhibitRules:
    - equal: ["alertname", "namespace"]
      sourceMatch:
        - name: severity
          value: critical
          matchType: =
      targetMatch:
        - name: severity
          value: warning
          matchType: =
  receivers:
    - name: "null"
    # - name: heartbeat
    #   webhookConfigs:
    #     - urlSecret:
    #         name: &secret alertmanager
    #         key: ALERTMANAGER_HEARTBEAT_URL
    - name: discord
      discordConfigs:
        - sendResolved: false
          apiURL:
            name: alertmanager
            key: DISCORD_WEBHOOK_URL
          title: >-
            [{{ .Status | toUpper }}] [{{ .CommonLabels.alertname }}]: {{
              with .CommonAnnotations.description -}}
                {{ . }}
              {{- else -}}
                {{ (index .Alerts 0).Annotations.description }}
              {{- end }}
