---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/tags/app-template-4.6.2/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jellarr
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    timeout: 2m
  rollback:
    # force necessary for a job
    force: true
  upgrade:
    # force necessary for a job
    force: true
    timeout: 2m
  dependsOn:
    - name: jellyfin
  values:
    controllers:
      jellarr:
        type: job
        pod:
          hostUsers: false
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch
            seccompProfile: { type: RuntimeDefault }
        containers:
          main:
            image:
              repository: ghcr.io/venkyr77/jellarr
              tag: v0.1.0@sha256:b16c867f06b53556fdc31f1514d5e955414f3132724ecafe41e796d781214f79
            env:
              JELLARR_API_KEY:
                secretKeyRef:
                  name: jellarr
                  key: API_KEY
            securityContext: &sec
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 1m
                memory: 5Mi
              limits:
                memory: 124Mi
    persistence:
      config:
        type: configMap
        name: jellarr
        globalMounts:
          - path: /config/config.yml
            subPath: config.yml
    configMaps:
      config:
        data:
          config.yml: |
            version: 1
            base_url: http://jellyfin:8096
            system:
              enableMetrics: true
              pluginRepositories:
                - name: Jellyfin Official
                  url: https://repo.jellyfin.org/files/plugin/manifest.json
                  enabled: true
                - name: Intro Skipper
                  url: https://intro-skipper.org/manifest.json
                  enabled: true
                - name: Streamyfin
                  url: https://raw.githubusercontent.com/streamyfin/jellyfin-plugin-streamyfin/main/manifest.json
                  enabled: true
              trickplayOptions:
                enableHwAcceleration: true
                enableHwEncoding: true
            encoding:
              enableHardwareEncoding: true
              hardwareAccelerationType: "qsv"
              hardwareDecodingCodecs:
                - h264
                - hevc
                - mpeg2video
                - vc1
                - vp8
                - vp9
                - av1
              enableDecodingColorDepth10Hevc: true
              enableDecodingColorDepth10Vp9: true
              enableDecodingColorDepth10HevcRext: true
              enableDecodingColorDepth12HevcRext: true
              allowHevcEncoding: true
              allowAv1Encoding: true
