---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencloud
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      ${APP}:
        forceRename: ${APP}
        strategy: RollingUpdate
        containers:
          main:
            image: &img
              repository: docker.io/opencloudeu/opencloud-rolling
              tag: 3.5.0@sha256:15963603ee31edf92317dea6ccd420afd9c40caf95d5ebc9901e42eb339789ef
            command:
              - "/bin/sh"
              - "-c"
              - "opencloud init || true; opencloud server"
            env:
              OC_ADMIN_USER_ID: "" # admin from pocket id
              OC_ENABLE_OCM: false
              OC_INSECURE: false
              OC_LOG_LEVEL: warn
              OC_URL: &url https://cloud.${SECRET_DOMAIN}
              OC_OIDC_ISSUER: https://id.${SECRET_DOMAIN}
              OC_EXCLUDE_RUN_SERVICES: idp
              OC_ADD_RUN_SERVICES: notifications
              OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: true
              OC_OIDC_CLIENT_ID: opencloud-web

              FRONTEND_APP_HANDLER_SECURE_VIEW_APP_ADDR: eu.opencloud.api.collaboration.CollaboraOnline
              GRAPH_AVAILABLE_ROLES: "b1e2218d-eef8-4d4c-b82d-0f1a1b48f3b5,a8d5fe5e-96e3-418d-825b-534dbdf22b99,fb6c3e19-e378-47e5-b277-9732f9de6e21,58c63c02-1d89-4572-916a-870abc5a1b7d,2d00ce52-1fc2-4dbc-8b95-a73b73395f5a,1c996275-f1c9-4e71-abdf-a42f6495e960,312c0871-5ef7-4b3a-85b6-0e4074c64049,aa97fe03-7980-45ac-9e50-b325749fd7e6"

              PROXY_TLS: false
              PROXY_AUTOPROVISION_ACCOUNTS: true
              # PROXY_ROLE_ASSIGNMENT_DRIVER: oidc
              PROXY_ROLE_ASSIGNMENT_DRIVER: default # clients don't request proper claims to use oidc for group mapping yet
              PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM: groups
              PROXY_USER_OIDC_CLAIM: sub
              PROXY_AUTOPROVISION_CLAIM_USERNAME: sub
              PROXY_USER_CS3_CLAIM: username
              WEB_OIDC_SCOPE: "openid profile email groups"
              PROXY_CSP_CONFIG_FILE_LOCATION: &cspPath /etc/opencloud/csp.yaml\
              PROXY_OIDC_REWRITE_WELLKNOWN: true # mobile apps try to re-register via internal idp
              PROXY_HTTP_ADDR: 0.0.0.0:9200

              # For collaboration to connect
              GATEWAY_GRPC_ADDR: 0.0.0.0:9142
              NATS_NATS_HOST: 0.0.0.0
              NATS_NATS_PORT: 9233

              OC_CACHE_STORE: nats-js-kv
              MICRO_REGISTRY_ADDRESS: 127.0.0.1:9233
              MICRO_REGISTRY: nats-js-kv
              OC_CACHE_STORE_NODES: 127.0.0.1:9233
              OC_PERSISTENT_STORE_NODES: 127.0.0.1:9233
              OC_EVENTS_ENDPOINT: 127.0.0.1:9233

              SETTINGS_SETUP_DEFAULT_ASSIGNMENTS: false

              GRAPH_ASSIGN_DEFAULT_USER_ROLE: false
              GRAPH_USERNAME_MATCH: "none"

              WEB_OPTION_ACCOUNT_EDIT_LINK_HREF: https://id.${SECRET_DOMAIN}/settings/apps

              NOTIFICATIONS_SMTP_HOST: smtp-relay.smtp-relay
              NOTIFICATIONS_SMTP_PORT: 25
              NOTIFICATIONS_SMTP_SENDER: bot@${SECRET_DOMAIN}
              NOTIFICATIONS_SMTP_INSECURE: true

              STORAGE_USERS_DRIVER: posix
              STORAGE_USERS_ID_CACHE_STORE: nats-js-kv
              STORAGE_USERS_POSIX_ROOT: &path /data

              SEARCH_EXTRACTOR_TYPE: tika
              SEARCH_EXTRACTOR_TIKA_TIKA_URL: http://opencloud-tika:9998
              FRONTEND_FULL_TEXT_SEARCH_ENABLED: "true"
            securityContext: &sec
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                memory: 2Gi
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: &port 9200
                    path: /health
              readiness: *probes
      wopi:
        strategy: RollingUpdate
        containers:
          main:
            image: *img
            command:
              - "/bin/sh"
              - "-c"
              - "opencloud collaboration server"
            env:
              COLLABORATION_WOPI_SRC: http://opencloud-wopi:9300
              COLLABORATION_APP_PROOF_DISABLE: true
              COLLABORATION_APP_NAME: CollaboraOnline
              COLLABORATION_APP_PRODUCT: Collabora
              COLLABORATION_APP_INSECURE: true
              COLLABORATION_CS3API_DATAGATEWAY_INSECURE: true
              COLLABORATION_APP_ADDR: https://collabora.${SECRET_DOMAIN}
              COLLABORATION_APP_ICON: https://collabora.${SECRET_DOMAIN}/favicon.ico
              COLLABORATION_GRPC_ADDR: 0.0.0.0:9301
              COLLABORATION_HTTP_ADDR: 0.0.0.0:9300
              MICRO_REGISTRY_ADDRESS: opencloud:9233
              OC_PERSISTENT_STORE_NODES: opencloud:9233
              OC_CACHE_STORE: nats-js-kv
              MICRO_REGISTRY: nats-js-kv
              OC_URL: *url
            securityContext: *sec
      collabora:
        strategy: RollingUpdate
        pod:
          hostUsers: false
          securityContext:
            seccompProfile:
              type: Unconfined
        containers:
          main:
            image:
              repository: docker.io/collabora/code
              tag: 25.04.5.3.1@sha256:d655791f533f28bc32431a2fcf33a36cadd05ef6745a2b597a4e6534021bdc88
            command:
              - "/bin/bash"
              - "-c"
              - "coolconfig generate-proof-key && /start-collabora-online.sh"
            env:
              aliasgroup1: http://opencloud-wopi:9300
              DONT_GEN_SSL_CERT: "YES"
              extra_params: |
                --o:ssl.enable=false \
                --o:ssl.ssl_verification=false \
                --o:ssl.termination=true \
                --o:welcome.enable=false \
                --o:net.frame_ancestors=cloud.${SECRET_DOMAIN}
              username:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: COLLABORA_ADMIN_USER
              password:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: COLLABORA_ADMIN_PASS
            securityContext:
              <<: *sec
              readOnlyRootFilesystem: false
              capabilities:
                add:
                  # https://sdk.collaboraonline.com/docs/installation/CODE_Docker_image.html#running-with-minimal-capabilities
                  - SYS_CHROOT
                  - SYS_ADMIN
                drop:
                  - ALL
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: 9980
                    path: /hosting/discovery
              readiness: *probes
      tika:
        strategy: RollingUpdate
        pod:
          hostUsers: false
        containers:
          main:
            image:
              repository: docker.io/apache/tika
              tag: 3.2.3.0-full@sha256:21d8052de04e491ccf66e8680ade4da6f3d453a56d59f740b4167e54167219b7
            env:
              JAVA_OPTS: "-Xmx3g"
            securityContext: *sec
            resources:
              requests:
                cpu: 200m
                memory: 500Mi
              limits:
                memory: 5Gi
    defaultPodOptionsStrategy: merge
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }
    service:
      opencloud:
        forceRename: ${APP}
        controller: ${APP}
        ports:
          http:
            port: *port
          nats:
            port: 9233
          grpc:
            port: 9142
      tika:
        controller: tika
        ports:
          http:
            port: 9998
      wopi:
        controller: wopi
        ports:
          http:
            port: 9300
          grpc:
            port: 9301
      collabora:
        controller: collabora
        ports:
          http:
            port: 9980
    route:
      main:
        hostnames:
          - cloud.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: ${APP}
              port: *port
            timeouts:
              request: 0s
      wopi:
        hostnames:
          - wopi.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: wopi
              port: 9300
            timeouts:
              request: 0s
      collabora:
        hostnames:
          - collabora.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: collabora
              port: 9980
            timeouts:
              request: 0s
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  add:
                    - name: X-Forwarded-Proto
                      value: https
                    - name: X-Forwarded-Host
                      value: collabora.${SECRET_DOMAIN}
    persistence:
      config:
        type: configMap
        name: ${APP}-config
        advancedMounts:
          opencloud:
            main:
              - path: *cspPath
                subPath: csp.yaml
              - path: /etc/opencloud/proxy.yaml
                subPath: proxy.yaml
      data:
        existingClaim: ${APP}
        advancedMounts:
          opencloud:
            main:
              - path: /var/lib/opencloud
                subPath: data
              - path: /etc/opencloud
                subPath: config
          wopi:
            main:
              - path: /etc/opencloud
                subPath: config
      files:
        existingClaim: files
        advancedMounts:
          opencloud:
            main:
              - path: *path
      tmpfs:
        type: emptyDir
        advancedMounts:
          tika:
            main:
              - path: /tmp
          collabora:
            main:
              - path: /tmp
                subPath: tmp
              - path: /opt/cool/cache
                subPath: cache
              - path: /opt/cool/child-roots
                subPath: roots
