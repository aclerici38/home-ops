---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencloud
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: opencloud
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  dependsOn:
    - name: nats
      namespace: nats
    - name: versity
      namespace: versity
  values:
    image:
      registry: docker.io
      repository: opencloudeu/opencloud-rolling
      tag: 3.5.0@sha256:15963603ee31edf92317dea6ccd420afd9c40caf95d5ebc9901e42eb339789ef
    opencloud:
      replicas: 1
      logLevel: warn
      insecure: false
      existingSecret: opencloud-secret
      excludeServices:
        - idp
        - ocm
      env:
        - name: OC_MACHINE_AUTH_API_KEY
          valueFrom:
            secretKeyRef:
              name: opencloud-secret
              key: MACHINE_AUTH_API_KEY
        - name: OC_JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: opencloud-secret
              key: JWT_SECRET
        - name: OC_SERVICE_ACCOUNT_ID
          valueFrom:
            secretKeyRef:
              name: ${APP}-secret
              key: SERVICE_ACCOUNT_ID
        - name: OC_SERVICE_ACCOUNT_SECRET
          valueFrom:
            secretKeyRef:
              name: ${APP}-secret
              key: SERVICE_ACCOUNT_SECRET
      persistence:
        config:
          existingClaim: opencloud
        # Mainly apache tika info
        data:
          existingClaim: opencloud-cache
      smtp:
        enabled: true
        host: smtp-relay.smtp-relay
        port: "25"
        sender: bot@${SECRET_DOMAIN}
        authentication: "none"
        encryption: "none"
      storage:
        mode: s3
        s3:
          internal:
            enabled: false
          external:
            enabled: true
            endpoint: http://versity.versity:7070
            existingSecret: opencloud-secret
            bucket: files
            createBucket: false
    httpRoute:
      enabled: true
      gateway:
        create: false
        name: external
        className: envoy
        namespace: envoy
        sectionName: https
    global:
      domain:
        opencloud: files.${SECRET_DOMAIN}
        collabora: collabora.${SECRET_DOMAIN}
        wopi: wopi.${SECRET_DOMAIN}
        keycloak: id.${SECRET_DOMAIN}
      tls:
        enabled: false
      oidc:
        issuer: https://id.${SECRET_DOMAIN}
        clientid: "web"
        accountUrl: id.${SECRET_DOMAIN}/settings/apps
    keycloak:
      internal:
        enabled: false
    postgres:
      enabled: false
    tika:
      image:
        registry: docker.io
        repository: apache/tika
        tag: 3.2.3.0-full@sha256:21d8052de04e491ccf66e8680ade4da6f3d453a56d59f740b4167e54167219b7
    webExtensions:
      image:
        registry: docker.io
        repository: opencloudeu/web-extensions
      # The paths here seem broken for now
      # extensions:
      #   drawio:
      #     tag: draw-io-1.0.0@sha256:27cb9b952f0d6f511ab88259e9271a4087328f151950b5a73ceaf89e50fb6e89
      #   externalsites:
      #     tag: external-sites-1.2.0@sha256:e2a18530f9f994beae5d3b7e1934dfb9ea51760e9b624e16541feda816062b9b
      #   importer:
      #     tag: importer-1.0.0@sha256:6e8b2df6c5a44b7e446f0f518a35d851705022ef0b0e92910a86e0319d7d0666
      #   jsonviewer:
      #     tag: json-viewer-1.0.1@sha256:9ca19defb6cd37dbd2f52ff52504153f4ba6e270d62c59de972b1ef5a445215a
      #   progressbars:
      #     tag: progress-bars-1.0.0@sha256:82f888a34440c4ed93a98ecb9eb2f7dcd1cf58ddbbb75ccd2c9aea28023920d8
      #   unzip:
      #     tag: unzip-1.0.3@sha256:3cd4ffdc93ff893f7f1c75c2e63c059a6da62720a394bd9ba33719236e6579b8
    onlyoffice:
      enabled: false
    collabora:
      enabled: true
      image:
        registry: docker.io
        repository: collabora/code
        tag: 25.04.5.2.1@sha256:74031c1ecf6823dc9abd1a97142fef01797bdd7dc93aef0b8b09145ed2273cc3
      ssl:
        enabled: false
      existingSecret: opencloud-secret
