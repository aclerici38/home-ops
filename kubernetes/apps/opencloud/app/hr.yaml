---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencloud
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      ${APP}:
        forceRename: ${APP}
        strategy: RollingUpdate
        containers:
          main:
            image: &img
              repository: docker.io/opencloudeu/opencloud-rolling
              tag: 3.5.0@sha256:15963603ee31edf92317dea6ccd420afd9c40caf95d5ebc9901e42eb339789ef
            command:
              - "/bin/sh"
              - "-c"
              - "opencloud init || true; opencloud server"
            env:
              OC_ADMIN_USER_ID: "" # admin from pocket id
              OC_ENABLE_OCM: false
              OC_INSECURE: false
              OC_LOG_LEVEL: warn
              OC_URL: &url https://cloud.${SECRET_DOMAIN}
              OC_CORS_ALLOW_ORIGINS: *url
              OC_OIDC_ISSUER: https://id.${SECRET_DOMAIN}
              OC_EXCLUDE_RUN_SERVICES: idp,ocm
              OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: true

              FRONTEND_APP_HANDLER_SECURE_VIEW_APP_ADDR: eu.opencloud.api.collaboration.CollaboraOnline

              PROXY_TLS: false
              PROXY_AUTOPROVISION_ACCOUNTS: true
              PROXY_ROLE_ASSIGNMENT_DRIVER: oidc
              PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM: groups
              PROXY_USER_OIDC_CLAIM: sub
              PROXY_AUTOPROVISION_CLAIM_USERNAME: sub
              PROXY_USER_CS3_CLAIM: username
              WEB_OIDC_SCOPE: "openid profile email groups"
              PROXY_CSP_CONFIG_FILE_LOCATION: &cspPath /etc/opencloud/csp.yaml

              # For collaboration to connect
              NATS_NATS_HOST: 0.0.0.0
              GATEWAY_GRPC_ADDR: 0.0.0.0:9142

              MICRO_REGISTRY_ADDRESS: 127.0.0.1:9233
              MICRO_REGISTRY: "nats-js-kv"

              SETTINGS_SETUP_DEFAULT_ASSIGNMENTS: false

              GRAPH_ASSIGN_DEFAULT_USER_ROLE: false
              GRAPH_USERNAME_MATCH: "none"

              WEB_OPTION_ACCOUNT_EDIT_LINK_HREF: https://id.${SECRET_DOMAIN}/settings/apps

              NOTIFICATIONS_SMTP_HOST: smtp-relay.smtp-relay
              NOTIFICATIONS_SMTP_PORT: 25
              NOTIFICATIONS_SMTP_SENDER: bot@${SECRET_DOMAIN}
              NOTIFICATIONS_SMTP_INSECURE: true

              STORAGE_USERS_DRIVER: decomposeds3
              STORAGE_USERS_DECOMPOSEDS3_ENDPOINT: http://versity.versity:7070
              STORAGE_USERS_DECOMPOSEDS3_BUCKET: files
              STORAGE_USERS_DECOMPOSEDS3_REGION: us-east-1
              STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: accessKey
              STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: secretKey

              SEARCH_EXTRACTOR_TYPE: tika
              SEARCH_EXTRACTOR_TIKA_TIKA_URL: http://opencloud-tika:9998
            securityContext: &sec
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                memory: 2Gi
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: &port 9200
                    path: /health
              readiness: *probes
      collaboration:
        strategy: RollingUpdate
        containers:
          main:
            image: *img
            command:
              - "/bin/sh"
              - "-c"
              - "opencloud collaboration server"
            env:
              COLLABORATION_WOPI_SRC: http://opencloud-collaboration:9300
              COLLABORATION_APP_NAME: CollaboraOnline
              COLLABORATION_APP_PRODUCT: Collabora
              COLLABORATION_APP_ADDR: https://collabora.${SECRET_DOMAIN}
              COLLABORATION_APP_ICON: https://collabora.#{SECRET_DOMAIN}/favicon.ico
              COLLABORATION_GRPC_ADDR: 0.0.0.0:9301
              COLLABORATION_HTTP_ADDR: 0.0.0.0:9300
              MICRO_REGISTRY_ADDRESS: opencloud:9233
              MICRO_REGISTRY: "nats-js-kv"
              OC_URL: *url
            securityContext: *sec
      collabora:
        strategy: RollingUpdate
        containers:
          main:
            image:
              repository: docker.io/collabora/code
              tag: 25.04.5.2.1@sha256:74031c1ecf6823dc9abd1a97142fef01797bdd7dc93aef0b8b09145ed2273cc3
            command:
              - /bin/bash
              - -c
              - coolconfig generate-proof-key && /start-collabora-online.sh
            env:
              aliasgroup1: https://wopi.${SECREP_DOMAIN}
              DONT_GEN_SSL_CERT: "YES"
              extra_params: |-
                --o:ssl.enable=true \
                --o:ssl.ssl_verification=true \
                --o:ssl.termination=false \
                --o:welcome.enable=false \
                --o:net.frame_ancestors=cloud.${SECRET_DOMAIN}
              username:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: COLLABORA_ADMIN_USER
              password:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: COLLABORA_ADMIN_PASS
            securityContext:
              <<: *sec
              capabilities:
                add:
                  - MKNOD
                drop:
                  - ALL
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: &port 9980
                    path: /hosting/discovery
              readiness: *probes
      tika:
        strategy: RollingUpdate
        containers:
          main:
            image:
              repository: docker.io/apache/tika
              tag: 3.2.3.0-full@sha256:21d8052de04e491ccf66e8680ade4da6f3d453a56d59f740b4167e54167219b7
            env:
              JAVA_OPTS: "-Xmx3g"
            securityContext: *sec
            resources:
              requests:
                cpu: 200m
                memory: 500Mi
              limits:
                memory: 5Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }
    service:
      opencloud:
        forceRename: ${APP}
        controller: ${APP}
        ports:
          http:
            port: *port
      tika:
        controller: tika
        ports:
          http:
            port: 9998
      collaboration:
        controller: collaboration
        ports:
          http:
            port: 9300
          grpc:
            port: 9301
      collabora:
        controller: collabora
        ports:
          http:
            port: 9980
    route:
      main:
        hostnames:
          - cloud.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: ${APP}
              port: *port
      collaboration:
        hostnames:
          - wopi.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: collaboration
              port: 9300
      collabora:
        hostnames:
          - collabora.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy
            sectionName: https
        rules:
          - backendRefs:
            - identifier: collabora
              port: 9980
    persistence:
      config:
        type: configMap
        name: ${APP}-config
        advancedMounts:
          opencloud:
            main:
              - path: *cspPath
                subPath: csp.yaml
              - path: /etc/opencloud/proxy.yaml
                subPath: proxy.yaml
      data:
        existingClaim: ${APP}
        advancedMounts:
          opencloud:
            main:
              - path: /var/lib/opencloud
                subPath: data
              - path: /etc/opencloud
                subPath: config
          collaboration:
            main:
              - path: /etc/opencloud
                subPath: config
      tmpfs:
        type: emptyDir
        advancedMounts:
          tika:
            main:
              - path: /tmp
          collabora:
            main:
              - path: /tmp
                subPath: tmp
              - path: /opt/cool/child-roots/
                subPath: cool
