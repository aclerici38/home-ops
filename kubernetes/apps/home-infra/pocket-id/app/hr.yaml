---
# yaml-language-server: $schema=https://github.com/aclerici38/pocket-id-operator/releases/latest/download/helmrelease_v2_pocket-id-operator.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pocket-id-operator
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: pocket-id-operator
  install:
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    timeout: 2m
    remediation:
      retries: 1
  values:
    # operator:
    #   image:
    #     tag: 235209d-main
    instance:
      name: pocket-id
      spec:
        image: ghcr.io/pocket-id/pocket-id:v2.3.0-distroless@sha256:85a7485108325e34679b0fbca0baeb8418401f6d6cf59944d50f3ec013aafd09
        route:
          enabled: true
          parentRefs:
            - group: gateway.networking.k8s.io
              kind: Gateway
              name: external
              namespace: gateway-system
              sectionName: https
        encryptionKey:
          valueFrom:
            secretKeyRef:
              name: pocket-id
              key: ENCRYPTION_KEY
        databaseUrl:
          valueFrom:
            secretKeyRef:
              name: pocket-id-db-app
              key: uri
        appUrl: https://id.${SECRET_DOMAIN}
        hostUsers: false
        versionCheckDisabled: true
        fileBackend: database
        ui:
          sessionDuration: 1440
        smtp:
          host: smtp-relay.cluster-infra.svc.cluster.local
          from: bot@${SECRET_DOMAIN}
          port: 25
          tls: none
        emailNotifications:
          loginNotification: true
          oneTimeAccessAsAdmin: true
          apiKeyExpiration: true
          verification: true
        persistence:
          enabled: false
        metrics:
          enabled: true
          
      serviceMonitor:
        enabled: true
    users:
      - name: anthony
        spec:
          locale: en
          admin: true
          email: 
            valueFrom:
              key: EMAIL
              name: cluster-settings
          firstName: 
            value: Anthony
          lastName: 
            value: Clerici
      - name: steve
        spec:
          locale: en
          userInfoSecretRef:
            name: pocket-id-steve-info
          