---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pocket-id-operator
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: pocket-id-operator
    namespace: flux-system
  install:
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    timeout: 2m
    remediation:
      retries: 1
  values:
    instance:
      name: pocket-id
      spec:
        image: ghcr.io/pocket-id/pocket-id:v2.1.0-distroless@sha256:188fa3c6e7852e325ffcb7affe4572e314855ba2b15627af2950143e73609dac
        auth:
          userRef:
            name: anthony
        encryptionKey:
          valueFrom:
            secretKeyRef:
              name: pocket-id
              key: ENCRYPTION_KEY
        databaseUrl:
          valueFrom:
            secretKeyRef:
              name: pocket-id-db-app
              key: uri
        appUrl: https://id.${SECRET_DOMAIN}
        hostUsers: false
        env:
          - name: UPDATE_CHECK_DISABLED
            value: true
          - name: SESSION_DURATION
            value: 1440
          - name: FILE_BACKEND
            value: database
          - name: EMAIL_LOGIN_NOTIFICATION_ENABLED
            value: true
          - name: SMTP_HOST
            value: smtp-relay.cluster-infra.svc.cluster.local
          - name: SMTP_PORT
            value: 25
          - name: SMTP_FROM
            value: bot@${SECRET_DOMAIN}
          - name: SMTP_TLS
            value: none
      route:
        enabled: true
        host: id.${SECRET_DOMAIN}
        parentRefs:
          - group: gateway.networking.k8s.io
            kind: Gateway
            name: external
            namespace: envoy-system
            sectionName: https
    extraManifests:
      - |
        apiVersion: pocketid.internal/v1alpha1
        kind: PocketIDUser
        metadata:
          name: anthony
        spec:
          admin: true
          email:
            firstName: Anthony
            lastName: Clerici
            value: ${EMAIL}
          apiKeys:
            - name: pocket-id-operator
              description: "Used by pocket-id operator"    
              secretRef:
                name: pocket-id
                key: OPERATOR_API_KEY
