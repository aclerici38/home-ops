---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pocket-id-operator
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: pocket-id-operator
  install:
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    timeout: 2m
    remediation:
      retries: 1
  values:
    # operator:
    #   image:
    #     tag: 235209d-main
    instance:
      name: pocket-id
      spec:
        image: ghcr.io/pocket-id/pocket-id:v2.2.0-distroless@sha256:ad2d21a7b31d6b4f1d999caec794a5b5edeb97fc40801947158d62befd4203e3
        encryptionKey:
          valueFrom:
            secretKeyRef:
              name: pocket-id
              key: ENCRYPTION_KEY
        databaseUrl:
          valueFrom:
            secretKeyRef:
              name: pocket-id-db-app
              key: uri
        appUrl: https://id.${SECRET_DOMAIN}
        hostUsers: false
        env:
          - name: UPDATE_CHECK_DISABLED
            value: "true"
          - name: SESSION_DURATION
            value: "1440"
          - name: FILE_BACKEND
            value: "database"
          - name: EMAIL_LOGIN_NOTIFICATION_ENABLED
            value: "true"
          - name: SMTP_HOST
            value: "smtp-relay.cluster-infra.svc.cluster.local"
          - name: SMTP_PORT
            value: "25"
          - name: SMTP_FROM
            value: "bot@${SECRET_DOMAIN}"
          - name: SMTP_TLS
            value: "none"
        persistence:
          enabled: false
        metrics:
          enabled: true
      serviceMonitor:
        enabled: true
      route:
        enabled: true
        host: id.${SECRET_DOMAIN}
        parentRefs:
          - group: gateway.networking.k8s.io
            kind: Gateway
            name: external
            namespace: gateway-system
            sectionName: https
    users:
      - name: anthony
        spec:
          admin: true
          email: 
            value: ${EMAIL}
          firstName: 
            value: Anthony
          lastName: 
            value: Clerici
      - name: steve
        spec:
          userInfoSecretRef:
            name: pocket-id-steve-info
          