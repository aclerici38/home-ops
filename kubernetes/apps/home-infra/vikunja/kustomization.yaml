---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
generatorOptions:
  disableNameSuffixHash: true
configMapGenerator:
  - name: APP-app-vars
    literals:
      - APP=vikunja
components:
  - ../../../components/ks/app
  - ../../../components/kustomize/external-secret
  - ../../../components/kustomize/cnpg/init
patches:
  - patch: |
      apiVersion: external-secrets.io/v1
      kind: ClusterExternalSecret
      metadata:
        name: vikunja
      spec:
        externalSecretSpec:
          target:
            creationPolicy: Merge
            template:
              data:
                config.yml: |
                  auth:
                    local:
                      enabled: false
                    openid:
                      enabled: true
                      redirecturl: https://tasks.${SECRET_DOMAIN}/auth/openid
                      providers:
                        pocket-id:
                          name: Pocket ID
                          authurl: https://id.${SECRET_DOMAIN}
                          clientid: {{ .CLIENT_ID }}
                          clientsecret: {{ .CLIENT_SECRET }}
                          scope: openid profile email
