---
# yaml-language-server: $schema=https://datreeio.github.io/CRDs-catalog/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: immich-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    template:
      data:
        config.yaml: |
          server:
            loginPageMessage: Welcome to my personal Immich instance. Contact Anthony with any questions
          trash:
            enabled: true
            days: 30
          ffmpeg:
            targetVideoCodec: hevc
            acceptedVideoCodecs:
              - hevc
              - h264
            preset: slow
            crf: 18
            accel: vaapi
            accelDecode: true
            tonemap: "reinhard"
            targetResolution: "1080"
          
          job:
            smartSearch:
              concurrency: 4
            faceDetection:
              concurrency: 4
            search:
              concurrency: 10
            migration:
              concurrency: 10
            thumbnailGeneration:
              concurrency: 6
            videoConversion:
              concurrency: 3
            ocr:
              concurrency: 1
          
          machineLearning:
            urls: ["http://immich-ml:3003"]
            clip:
              modelName: ViT-SO400M-16-SigLIP2-384__webli
            facialRecognition:
              modelName: buffalo_l
              minFaces: 1
            duplicateDetection:
              enabled: true
              maxDistance: 0.001
            ocr:
              enabled: true
              maxResolution: 2038
              minDetectionScore: 0.1
              minRecognitionScore: 0.1
              modelName: EN__PP-OCRv5_mobile
          
          oauth:
            enabled: true
            issuerUrl: https://id.${SECRET_DOMAIN}/
            autoLaunch: false
            autoRegister: true
            buttonText: Login with Pocket ID
            clientId: {{ .CLIENT_ID }}
            clientSecret: {{ .CLIENT_SECRET }}
          
          notifications:
            smtp:
              enabled: true
              from: Immich <bot@${SECRET_DOMAIN}>
              transport:
                host: smtp-relay.cluster-infra.svc.cluster.local
                port: 25
          
          storageTemplate:
            enabled: true
            hashVerificationEnabled: true
            template: {{ printf "%q" "{{album}}/{{y}}/{{MM}}/{{filename}}" }}
          
          passwordLogin:
            enabled: false
          
          backup:
            database:
              enabled: false
  dataFrom:
    - extract:
        key: immich
