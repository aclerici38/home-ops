---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/tags/app-template-4.6.2/charts/library/common/values.schema.json
controllers:
  onepassword-connect:
    strategy: RollingUpdate
    replicas: 1
    defaultContainerOptionsStrategy: merge
    defaultContainerOptions:
      env:
        XDG_DATA_HOME: &configDir /config
        OP_SESSION:
          valueFrom:
            secretKeyRef:
              name: onepassword-connect
              key: 1password-credentials.json
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities: { drop: ["ALL"] }
      resources:
        requests:
          cpu: 10m
        limits:
          memory: 256M
    pod:
      hostUsers: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }
    containers:
      api:
        image:
          repository: docker.io/1password/connect-api
          tag: 1.8.1@sha256:8fe7bcd50c9e73899e0a1aa5aa43421ca75fbceacb33dd07f6418c4116e637a1
        env:
          OP_HTTP_PORT: &apiPort 80
          OP_BUS_PORT: 11220
          OP_BUS_PEERS: localhost:11221
        probes: &probes
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /heartbeat
                port: *apiPort
              initialDelaySeconds: 15
              periodSeconds: 30
              failureThreshold: 3
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: *apiPort
              initialDelaySeconds: 15
      sync:
        image:
          repository: docker.io/1password/connect-sync
          tag: 1.8.1@sha256:d5e937b2b7e314dbbaffacf469dc8f30376b5954a3ad836c8d96e6cb579d7fab
        env:
          OP_HTTP_PORT: 8081
          OP_BUS_PORT: 11221
          OP_BUS_PEERS: localhost:11220
        probes: *probes
service:
  onepassword-connect:
    controller: onepassword-connect
    ports:
      http:
        port: *apiPort
persistence:
  config:
    type: emptyDir
    globalMounts:
      - path: *configDir
