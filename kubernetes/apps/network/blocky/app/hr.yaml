---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: blocky
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      blocky:
        strategy: RollingUpdate
        replicas: 2
        rollingUpdate:
          surge: 1
          unavailable: 1
        pod:
          tolerations:
            - key: "rpi"
              operator: "Equal"
              value: "true"
              effect: "NoSchedule"
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      app.kubernetes.io/instance: blocky
                  topologyKey: kubernetes.io/hostname
          hostUsers: false
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            seccompProfile: { type: RuntimeDefault }
        containers:
          main:
            image:
              repository: ghcr.io/0xerr0r/blocky
              tag: v0.28.2@sha256:5f84a54e4ee950c4ab21db905b7497476ece2f4e1a376d23ab8c4855cabddcba
            env:
              PGCONNECT_TIMEOUT: 10
              PGHOST:
                valueFrom:
                  secretKeyRef:
                    name: blocky-db-app
                    key: host
              PGPORT:
                valueFrom:
                  secretKeyRef:
                    name: blocky-db-app
                    key: port
              PGUSER:
                valueFrom:
                  secretKeyRef:
                    name: blocky-db-app
                    key: username
              PGPASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: blocky-db-app
                    key: password
              PGDATABASE:
                valueFrom:
                  secretKeyRef:
                    name: blocky-db-app
                    key: dbname
            probes:
              readiness: &probes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /app/blocky
                      - healthcheck
              liveness: *probes
            resources:
              requests:
                cpu: 50m
                memory: 100Mi
              limits:
                memory: 512Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                add:
                  - NET_BIND_SERVICE
                drop:
                  - ALL
    service:
      dns:
        controller: blocky
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: "${BLOCKY_LB_IP:-1.1.1.1}"
          coredns.io/hostname: dot.${SECRET_DOMAIN}
        ports: &p
          dns-tcp:
            port: 53
          dns-udp:
            port: 53
            protocol: UDP
          dns-tls:
            port: 853
      k8s:
        controller: blocky
        clusterIP: "${BLOCKY_CLUSTER_IP:-1.1.1.1}"
        ports:
          <<: *p
          http:
            port: &port 4000
    serviceMonitor:
      blocky:
        serviceName: blocky-k8s
        endpoints:
          - port: http
    route:
      blocky-DOH:
        hostnames:
          - dns.${SECRET_DOMAIN}
        parentRefs:
          - name: external
            namespace: envoy-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /dns-query
            backendRefs:
              - identifier: blocky
                port: *port
    persistence:
      config:
        type: configMap
        name: blocky
        globalMounts:
          - path: /app/config.yml
            subPath: config.yml
      tls:
        type: secret
        name: blocky-tls
        globalMounts:
          - path: /certs/tls.crt
            subPath: tls.crt
          - path: /certs/tls.key
            subPath: tls.key
    configMaps:
      config:
        data:
          config.yml: |
            caching:
              minTime: 2m
              maxTime: 1h
              maxItemsCount: 0
              prefetching: true
              prefetchExpires: 1h
              prefetchThreshold: 30
              prefetchMaxItemsCount: 0
              cacheTimeNegative: -1
            
            log:
              level: info
            
            minTlsServeVersion: 1.3
            certFile: /certs/tls.crt
            keyFile: /certs/tls.key
            ports:
              dns: 53
              tls: 853
              http: 4000
            
            prometheus:
              enable: true
            
            conditional:
              fallbackUpstream: false
              mapping:
                ${SECRET_DOMAIN}: ${K8S_GATEWAY_CLUSTER_IP}:53

                # House
                internal: 10.0.30.1:53
                0.10.in-addr.arpa: 10.0.30.1:53
                # kube
                cluster.local: ${COREDNS_CLUSTER_IP}
                16.172.in-addr.arpa: ${COREDNS_CLUSTER_IP}
            
            # ClientLookup is set to blocky so it can conditionally forward it to coredns/apt/house DHCP
            clientLookup:
              upstream: 127.0.0.1
              clients:
                localhost:
                  - 127.0.0.1
            
            # To resolve devices behind coredns
            ecs:
              useAsClient: true
              forward: false
            
            bootstrapDns:
              - https://1.1.1.1/dns-query
            
            # dnssec:
            #   validate: true
            #   cacheExpirationHours: 2
            #   clockSkewToleranceSec: 300
            
            upstreams:
              init:
                strategy: fast
              groups:
                default:
                  - https://dns.pub/dns-query
                  - https://dns.quad9.net/dns-query
                  - https://freedns.controld.com/p0
                  - https://doh.opendns.com/dns-query
                  - https://cloudflare-dns.com/dns-query
            
            blocking:
              loading:
                strategy: fast
              denylists:
                ads:
                  - https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/multi.txt
              allowlists:
                ads:
                  - |
                    epi-graphql.conde.digital
              clientGroupsBlock:
                10.0.0.0/8:
                  - ads
  
            redis:
              address: dragonfly-db.database.svc.cluster.local:6379
              database: 4
              connectionAttempts: 10
              connectionCooldown: 60s
            
            queryLog:
              # https://github.com/0xERR0R/blocky/issues/1949
              # type: timescale
              type: postgresql
              logRetentionDays: 90
              creationAttempts: 5
              creationCooldown: 60s
              flushInterval: 5s
    