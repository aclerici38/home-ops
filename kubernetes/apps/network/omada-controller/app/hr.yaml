---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: omada-controller
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: omada-controller
  install:
    timeout: 2m
  upgrade:
    timeout: 2m
  values:
    initContainers:
      - name: ferretdb
        image: ghcr.io/ferretdb/ferretdb:2.7.0@sha256:5706414241eb84f0515512c37b46db0f1b1eac9e5ceb7e4c2523211c184b1985
        restartPolicy: Always
        env:
          - name: FERRETDB_AUTH
            value: "false"
          - name: FERRETDB_POSTGRESQL_URL
            valueFrom:
              secretKeyRef:
                key: uri
                name: omada-controller-db-app
        volumeMounts:
          - name: ferretdb-state
            mountPath: /state
        livenessProbe: &probe
          exec:
            command: ["/ferretdb", "ping"]
          failureThreshold: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe: *probe
    image:
      repository: docker.io/mbentley/omada-controller
      pullPolicy: IfNotPresent
      tag: 6.1.0.19@sha256:f60ed42fd65b507a3cc38bd998af8fa38bfa86277d8171589bfc2ef4da47eec9
    serviceAccount:
      create: false
    config:
      rootless: true
      # ferretdb sidecar
      externalMongoDBUrl: "mongodb://127.0.0.1:27017/app"
      ports:
        manageHttp: 8080
        manageHttps: 443
    service:
      type: LoadBalancer
      annotations:
        lbipam.cilium.io/ips: 10.38.55.10
        coredns.io/hostname: ${APP_URL}
    resources:
      requests:
        cpu: 500m
        memory: 1200Mi
      limits:
        memory: 5Gi
    persistence:
      data:
        storageClassName: ceph-filesystem
        size: 5Gi
      logs:
        storageClassName: ceph-filesystem
        size: 5Gi
      extraVolumes:
        - name: tls
          secret:
            secretName: omada-controller-tls
        - name: ferretdb-state
          emptyDir: {}
      extraVolumeMounts:
        - name: tls
          mountPath: /cert
          readOnly: true
      