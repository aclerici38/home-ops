---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gravity-etcd
spec:
  interval: 1h
  maxHistory: 1
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      etcd:
        type: statefulset
        strategy: RollingUpdate
        replicas: 3
        pod:
          # hostUsers: false
          tolerations:
            - key: "location"
              operator: "Equal"
              value: "house"
              effect: "NoSchedule"
            - key: "location"
              operator: "Equal"
              value: "cloud"
              effect: "NoSchedule"
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: kubernetes.io/hostname
              whenUnsatisfiable: DoNotSchedule
              labelSelector:
                matchLabels:
                  app.kubernetes.io/instance: gravity
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            seccompProfile: { type: RuntimeDefault }
        containers:
          main:
            image:
              repository: quay.io/coreos/etcd
              tag: v3.6.1
            command: [etcd]
            args:
              - --name=$(POD_NAME)
              - --listen-metrics-urls=http://0.0.0.0:2381
              - --listen-peer-urls=http://0.0.0.0:2380
              - --listen-client-urls=http://0.0.0.0:2379
              - --initial-advertise-peer-urls=http://$(POD_NAME).gravity-etcd.$(POD_NAMESPACE).svc:2380
              - --advertise-client-urls=http://$(POD_NAME).gravity-etcd.$(POD_NAMESPACE).svc:2379
              - --data-dir=/var/run/etcd/default.etcd
              - --initial-cluster=gravity-etcd-0=http://gravity-etcd-0.gravity-etcd.$(POD_NAMESPACE).svc:2380,gravity-etcd-1=http://gravity-etcd-1.gravity-etcd.$(POD_NAMESPACE).svc:2380,gravity-etcd-2=http://gravity-etcd-2.gravity-etcd.$(POD_NAMESPACE).svc:2380
              - --initial-cluster-state=existing
              - --initial-cluster-token=etcd-cluster
              - --auto-compaction-retention=5m
              - --snapshot-count=10000
              - --quota-backend-bytes=5100273664
            env:
              POD_NAME:
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              POD_NAMESPACE:
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
            securityContext: &sec
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: &client 2379
                    path: /livez
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    port: *client
                    path: readyz
    statefulset:
      subdomain: gravity-etcd
      volumeClaimTemplates:
        - name: data
          advancedMounts:
            etcd:
              main:
                - path: /var/run/etcd
          accessMode: "ReadWriteOnce"
          storageClass: local-path
          size: 5Gi
    service:
      etcd:
        controller: etcd
        clusterIP: None
        ports:
          client:
            port: *client
          peer:
            port: 2380
          metrics:
            port: 2381
