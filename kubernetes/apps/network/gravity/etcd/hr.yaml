---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app gravity-etcd
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      '1':
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: apartment
        containers:
          app: &container
            image:
              repository: quay.io/coreos/etcd
              tag: v3.5.21
            command:
              - /usr/local/bin/etcd
              - --name=$(POD_NAME)
              - --data-dir=/data
              - --initial-advertise-peer-urls=http://$(POD_NAME)-0:2380
              - --listen-peer-urls=http://0.0.0.0:2380
              - --listen-client-urls=http://0.0.0.0:2379
              - --advertise-client-urls=http://$(POD_NAME)-0:2379
              - --heartbeat-interval=400
              - --election-timeout=2000
              - --initial-cluster=etcd-1=http://gravity-etcd-1:2380,etcd-2=http://gravity-etcd-2:2380,etcd-3=http://gravity-etcd-3:2380
              - --initial-cluster-state=new
              - --initial-cluster-token=$(ETCD_TOKEN)
            env:
              POD_NAME: gravity-etcd-1
              ETCD_TOKEN: &token
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: ETCD_TOKEN
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
      '2':
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: house
        containers:
          app:
            <<: *container
            env:
              POD_NAME: gravity-etcd-2
              ETCD_TOKEN: *token
      '3':
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: cloud
        containers:
          app:
            <<: *container
            env:
              POD_NAME: gravity-etcd-3
              ETCD_TOKEN: *token
    defaultPodOptions:
      tolerations:
        - key: "location"
          operator: "Equal"
          value: "house"
          effect: "NoSchedule"
        - key: "location"
          operator: "Equal"
          value: "cloud"
          effect: "NoSchedule"
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: Always
        seccompProfile: { type: RuntimeDefault }
    service:
      global:
        controller: '1'
        extraSelectorLabels:
          app.kubernetes.io/instance: *app
        ports:
          etcd-client:
            port: 2379
          etcd-peer:
            port: 2380
      '1':
        controller: '1'
        ports: &ports
          etcd-client:
            port: 2379
          etcd-peer:
            port: 2380
      '2':
        controller: '2'
        ports: *ports
      '3':
        controller: '3'
        ports: *ports
    persistence:
      etcd-1:
        existingClaim: &instance etcd-1
        advancedMounts:
          *instance :
            app:
              - path: /data
      etcd-2:
        existingClaim: &instance etcd-2
        advancedMounts:
          *instance :
            app:
              - path: /data
      etcd-3:
        existingClaim: &instance etcd-3
        advancedMounts:
          *instance :
            app:
              - path: /data
