---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app gravity-etcd
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  upgrade:
    crds: CreateReplace
    timeout: 2m
    remediation:
      retries: 1
  values:
    controllers:
      apartment:
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: apartment
        containers:
          app: &container
            image:
              repository: quay.io/coreos/etcd
              tag: v3.6.0
            command:
              - /usr/local/bin/etcd
              - --name=$(POD_NAME)
              - --data-dir=/data
              - --initial-advertise-peer-urls=http://$(POD_NAME)-0:2380
              - --listen-peer-urls=http://0.0.0.0:2380
              - --listen-client-urls=http://0.0.0.0:2379
              - --advertise-client-urls=http://$(POD_NAME)-0:2379
              - --heartbeat-interval=400
              - --election-timeout=2000
              - --initial-cluster=gravity-etcd-apartment=http://gravity-etcd-apartment:2380,gravity-etcd-house=http://gravity-etcd-house:2380,gravity-etcd-cloud=http://gravity-etcd-cloud:2380
              - --initial-cluster-state=new
              - --initial-cluster-token=$(ETCD_TOKEN)
            env:
              POD_NAME: gravity-etcd-apartment
              ETCD_TOKEN: &token
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: ETCD_TOKEN
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
      house:
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: house
        containers:
          app:
            <<: *container
            env:
              POD_NAME: gravity-etcd-house
              ETCD_TOKEN: *token
      cloud:
        strategy: RollingUpdate
        type: statefulset
        pod:
          nodeSelector:
            location: cloud
        containers:
          app:
            <<: *container
            env:
              POD_NAME: gravity-etcd-cloud
              ETCD_TOKEN: *token
    defaultPodOptions:
      tolerations:
        - key: "location"
          operator: "Equal"
          value: "house"
          effect: "NoSchedule"
        - key: "location"
          operator: "Equal"
          value: "cloud"
          effect: "NoSchedule"
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: Always
        seccompProfile: { type: RuntimeDefault }
    service:
      global:
        controller: apartment
        extraSelectorLabels:
          app.kubernetes.io/instance: *app
        ports:
          etcd-client:
            port: 2379
          etcd-peer:
            port: 2380
      apartment:
        controller: apartment
        ports: &ports
          etcd-client:
            port: 2379
          etcd-peer:
            port: 2380
      house:
        controller: house
        ports: *ports
      cloud:
        controller: cloud
        ports: *ports
    persistence:
      etcd-apartment:
        existingClaim: etcd-apartment
        advancedMounts:
          apartment:
            app:
              - path: /data
      etcd-house:
        existingClaim: etcd-house
        advancedMounts:
          house:
            app:
              - path: /data
      etcd-cloud:
        existingClaim: etcd-cloud
        advancedMounts:
          cloud:
            app:
              - path: /data
