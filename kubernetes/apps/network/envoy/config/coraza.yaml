apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: coraza
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: external
  wasm:
    - name: coraza
      rootID: coraza-root
      code:
        type: Image
        image:
          url: ghcr.io/corazawaf/coraza-proxy-wasm:0.5.0
      config:
        default_directives: "default"
        directives_map:
          default:
            - "SecDebugLogLevel 9"
            - "SecRuleEngine On"
            # Custom
            # Pocket id
            - >
              SecRule REQUEST_HEADERS:Host "@streq pocket-id.${SECRET_DOMAIN}" "id:1000005,phase:1,pass,nolog,ctl:ruleRemoveById=949111,ctl:ruleRemoveById=911100,chain"
            - SecRule REQUEST_URI "@rx ^/api/oidc/clients/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            - >
              SecRule REQUEST_HEADERS:Host "@streq pocket-id.${SECRET_DOMAIN}" "id:1000006,phase:2,pass,nolog,ctl:ruleRemoveById=949110,chain"
            - SecRule REQUEST_URI "@rx ^/api/oidc/clients/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            # Default
            - "Include @crs-setup-conf"
            - "Include @owasp_crs/*.conf"
