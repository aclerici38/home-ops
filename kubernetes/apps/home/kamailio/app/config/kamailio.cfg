#!KAMAILIO

listen=udp:0.0.0.0:5060
log_stderror=yes
debug=3

loadmodule "sl.so"          # Stateless replies
loadmodule "tm.so"          # Transaction support
loadmodule "rr.so"          # Record-Routing
loadmodule "maxfwd.so"      # Loop detection
loadmodule "nathelper.so"   # NAT traversal
loadmodule "textops.so"     # SIP message inspection

modparam("nathelper", "natping_interval", 30)  # Keep NAT bindings alive
modparam("nathelper", "ping_nated_only", 1)    # Only ping NATed clients

route {
    # Drop malformed packets
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # NAT detection and fixing
    if (nat_uac_test("1")) {
        force_rport();           # Fix SIP signaling
        set_contact_alias();     # Rewrite Contact header
        fix_nated_register();    # Fix REGISTERs behind NAT
        fix_nated_contact();     # Fix Contact headers in all requests
    }

    # Add Record-Route (ensures SIP dialog stability)
    record_route();

    if (!t_relay("udp:sanjose1.voip.ms:5060")) {
        sl_reply_error();
    }
}
