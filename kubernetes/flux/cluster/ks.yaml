---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-apps
  namespace: flux-system
spec:
  interval: 30m
  timeout: 7m
  path: ./kubernetes/apps/
  prune: false
  wait: false
  dependsOn:
    - name: flux-settings
    - name: flux-repos
  sourceRef:
    kind: GitRepository
    name: flux-system
  patches:
    # Default: postBuild.subFrom does not exist
    - patch: |
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: patch
        spec:
          postBuild:
            substituteFrom:
              - kind: ConfigMap
                name: cluster-settings
                optional: false
              - kind: Secret
                name: cluster-secrets
                optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "!kustomize.dormammu/subfrom"
    # SubFrom does exist in the ks, this patch is chosen via labelSelector
    - patch: |
        - op: add
          path: /spec/postBuild/substituteFrom/-
          value:
            kind: Secret
            name: cluster-secrets
            optional: false
        - op: add
          path: /spec/postBuild/substituteFrom/-
          value:
            kind: ConfigMap
            name: cluster-settings
            optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "kustomize.dormammu/subfrom=exists"

    # Components via labels (fun)
    - patch: |
        - op: add
          path: /spec/components
          value: []
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization

    # Add dependsOn to ks based on whether it has the component or not
    # ESO: volsync, cnpg, ESO, oauth
    - patch: &eso |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets-stores
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # Versity: cnpg, volsync
    - patch: &versity |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    - patch: *versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    # Volsync: volsync
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: volsync
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # CNPG: cnpg
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: cloudnative-pg
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    # Envoy: oauth
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: envoy
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"

    # Add namespace component by default
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/namespace
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "!components.dormammu/noTargetNs"

    # Add hr defaults patch component by default
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/flux/helm
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "!components.dormammu/nohelm"

    # Add cnpg restore helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/cnpg/helm/restore
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=restore,!components.dormammu/nohelm"

    # Add cnpg init helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/cnpg/helm/init
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=init,!components.dormammu/nohelm"

    # Add cnpg helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/cnpg/helm/no-backup
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=no-backup,!components.dormammu/nohelm"

    # Add cnpg raw manifests component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/cnpg/raw/restore
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=restore,components.dormammu/nohelm"

    # Add envoy oauth component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/envoy/oauth/helm
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth,!components.dormammu/nohelm"

    # Add ESO component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/external-secret/helm/normal
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret=normal,!components.dormammu/nohelm"

    # Add ESO cluster secret component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/external-secret/helm/cluster
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret=cluster,!components.dormammu/nohelm"

    # Add volsync versity component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/volsync/helm/versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=versity,!components.dormammu/nohelm"

    # Add volsync remote component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../components/volsync/helm/remote
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=remote,!components.dormammu/nohelm"
