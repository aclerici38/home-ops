---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-apps
  namespace: flux-system
spec:
  targetNamespace: flux-system
  interval: 30m
  timeout: 7m
  path: ./kubernetes/apps/
  prune: false
  wait: false
  dependsOn:
    - name: flux-repos
  sourceRef:
    kind: GitRepository
    name: flux-system
  patches:

    # Add default values to helmRelease
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: defaults-patch
        spec:
          maxHistory: 1
          driftDetection:
            mode: warn
          install:
            crds: CreateReplace
            remediation:
              retries: 1
              remediateLastFailure: true
            strategy:
              name: RetryOnFailure
          upgrade:
            crds: CreateReplace
            cleanupOnFail: true
            strategy:
              name: RemediateOnFailure
            remediation:
              retries: 1
              remediateLastFailure: true
      target:
        kind: HelmRelease

    # Default: postBuild.subFrom does not exist
    - patch: |
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: patch
        spec:
          postBuild:
            substituteFrom:
              - kind: Secret
                name: cluster-settings
                optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "!kustomize.dormammu/subfrom,kustomize.dormammu/cluster-settings!=false"
    # SubFrom does exist in the ks, this patch is chosen via labelSelector
    - patch: |
        - op: add
          path: /spec/postBuild/substituteFrom/-
          value:
            kind: Secret
            name: cluster-settings
            optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "kustomize.dormammu/subfrom=exists,kustomize.dormammu/cluster-settings!=false"

    # Add NS var to each app ks
    - patch: |
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: patch
        spec:
          postBuild:
            substitute:
              NS: ${NS}
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "kustomize.dormammu/namespace!=true"
     # separate patch for targetNS via label
    - patch: |
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: patch
        spec:
          targetNamespace: ${NS}
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "kustomize.dormammu/namespace!=true,kustomize.dormammu/targetNS!=false"

    # Components via labels (fun)
    - patch: |
        - op: add
          path: /spec/components
          value: []
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization

    # Add dependsOn to ks based on whether it has the component or not
    # ESO: volsync, cnpg, ESO, oauth
    - patch: &eso |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets
            namespace: cluster-infra
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets-stores
            namespace: cluster-infra
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # Versity: cnpg, volsync
    - patch: &versity |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: versity
            namespace: storage
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=versity"
    - patch: *versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg,components.dormammu/cnpg!=no-backup"
    # Volsync: volsync
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: volsync
            namespace: storage
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # CNPG: cnpg
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: cloudnative-pg
            namespace: database
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    # Envoy: oauth
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: envoy
            namespace: envoy-system
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"

    # Add cnpg restore component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/overlays/restore
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=restore"

    # Add cnpg init component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/overlays/init
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=init"

    # Add cnpg component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/overlays/no-backup
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=no-backup"

    # Add envoy oauth component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/envoy/oauth
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"

    # Add ESO component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/external-secret
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret"

    # Add volsync versity component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/volsync/overlays/versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=versity"

    # Add volsync remote component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/volsync/overlays/remote
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=remote"
