---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-apps
  namespace: flux-system
spec:
  interval: 30m
  timeout: 7m
  path: ./kubernetes/apps/
  prune: false
  wait: false
  dependsOn:
    - name: flux-repos
  sourceRef:
    kind: GitRepository
    name: flux-system
  patches:
    # Make namespaces priv by default cuz why not
    - patch: |
        apiVersion: v1
        kind: Namespace
        metadata:
          labels:
            kustomize.toolkit.fluxcd.io/prune: disabled
            pod-security.kubernetes.io/enforce: &ps privileged
            pod-security.kubernetes.io/audit: *ps
            pod-security.kubernetes.io/warn: *ps
      target:
        group: v1
        kind: Namespace

    # Default: postBuild.subFrom does not exist
    - patch: |
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: patch
        spec:
          postBuild:
            substituteFrom:
              - kind: Secret
                name: cluster-settings
                optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "!kustomize.dormammu/subfrom,kustomize.dormammu/cluster-settings!=true"
    # SubFrom does exist in the ks, this patch is chosen via labelSelector
    - patch: |
        - op: add
          path: /spec/postBuild/substituteFrom/-
          value:
            kind: Secret
            name: cluster-settings
            optional: false
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "kustomize.dormammu/subfrom=exists,kustomize.dormammu/cluster-settings!=false"

    # Components via labels (fun)
    - patch: |
        - op: add
          path: /spec/components
          value: []
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization

    # Add dependsOn to ks based on whether it has the component or not
    # ESO: volsync, cnpg, ESO, oauth
    - patch: &eso |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets
            namespace: cluster-infra
        - op: add
          path: /spec/dependsOn/-
          value:
            name: external-secrets-stores
            namespace: cluster-infra
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret"
    - patch: *eso
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # Versity: cnpg, volsync
    - patch: &versity |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: versity
            namespace: storage
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=versity"
    - patch: *versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg,components.dormammu/cnpg!=no-backup"
    # Volsync: volsync
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: volsync
            namespace: storage
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync"
    # CNPG: cnpg
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: cloudnative-pg
            namespace: database
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg"
    # Envoy: oauth
    - patch: |
        - op: add
          path: /spec/dependsOn/-
          value:
            name: envoy
            namespace: envoy-system
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth"

    # Add hr defaults patch component by default
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/flux/helm
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/helm!=false"

    # Add app-vars component by default
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/app-vars/helm
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/app-vars!=false,components.dormammu/helm!=false"
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/app-vars/postBuild
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/app-vars!=false,components.dormammu/helm=false"

    # Add cnpg restore helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/helm/restore
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=restore,components.dormammu/helm!=false"

    # Add cnpg init helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/helm/init
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=init,components.dormammu/helm!=false"

    # Add cnpg helm component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/helm/no-backup
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=no-backup,components.dormammu/helm!=false"

    # Add cnpg raw manifests component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/cnpg/raw/restore
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/cnpg=restore,components.dormammu/helm=false"

    # Add envoy oauth component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/envoy/oauth/helm
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/oauth,components.dormammu/helm!=false"

    # Add ESO component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/external-secret/helm/normal
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret=normal,components.dormammu/helm!=false"

    # Add ESO cluster secret component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/external-secret/helm/cluster
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret=cluster,components.dormammu/helm!=false"
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/external-secret/postBuild/cluster
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/external-secret=cluster,components.dormammu/helm=false"

    # Add volsync versity component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/volsync/helm/versity
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=versity,components.dormammu/helm!=false"

    # Add volsync remote component if labelled
    - patch: |
        - op: add
          path: /spec/components/-
          value: ../../../../components/volsync/helm/remote
      target:
        group: kustomize.toolkit.fluxcd.io
        kind: Kustomization
        labelSelector: "components.dormammu/volsync=remote,components.dormammu/helm!=false"
